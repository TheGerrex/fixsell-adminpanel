<app-loading-spinner [isLoading]="isLoadingData"></app-loading-spinner>
<div class="ticket-container" *ngIf="!isLoadingData">
    <div class="ticket-header">
        <h3 class="ticket-header-title">Ticket #{{ ticketNumber }}</h3>
        <div class="ticket-header-container">
            <!-- Estado section moved here -->
            <div class="ticket-data-item">
                <p class="ticket-data-item-name">Estado</p>
                <select [(ngModel)]="ticketStatus" class="form-select" (change)="changeStatus()">
                  <option *ngFor="let option of statusOptions" [value]="option.value">
                    {{ option.label }}
                  </option>
                </select>
            </div>
            <div class="ticket-data-item">
                <p class="ticket-data-item-name">Prioridad</p>
                <select [(ngModel)]="ticketPriority" class="form-select" (change)="changeStatus()">
                  <option *ngFor="let option of priorityOptions" [value]="option.value">
                    {{ option.label }}
                  </option>
                </select>
            </div>

            <div class="ticket-data-item">
                <p class="ticket-data-item-name">Transferir Ticket</p>
                <select [(ngModel)]="ticket.assigned.name" class="form-select" (change)="transferTicket()">
          <option *ngFor="let user of users" [value]="user.name">
            {{ user.name }}
          </option>
        </select>
            </div>
        </div>
    </div>
    <div class="ticket-body">
        <div class="ticket-content">
            <div class="ticket-info-card">
                <div class="ticket-info-card-header">
                    <h4 class="ticket-info-card-header-title">Información del Ticket</h4>
                    <div class="ticket-info-icons">
                        <div class="ticket-status" [ngClass]="getStatusClass(ticket)">{{ticket.status | ticketStatus}}</div>
                        <div class="ticket-priority" [ngSwitch]="ticket.priority">
                            <div class="priority-flags-container high-priority" *ngSwitchCase="'high'">
                                <mat-icon [ngClass]="getPriorityClass(ticket)">flag</mat-icon>
                                <mat-icon [ngClass]="getPriorityClass(ticket)">flag</mat-icon>
                                <mat-icon [ngClass]="getPriorityClass(ticket)">flag</mat-icon>
                            </div>
                            <div class="priority-flags-container medium-priority" *ngSwitchCase="'medium'">
                                <mat-icon [ngClass]="getPriorityClass(ticket)">flag</mat-icon>
                                <mat-icon [ngClass]="getPriorityClass(ticket)">flag</mat-icon>
                                <mat-icon [ngClass]="getPriorityClass(ticket)">outlined_flag</mat-icon>
                            </div>
                            <div class="priority-flags-container low-priority" *ngSwitchCase="'low'">
                                <mat-icon [ngClass]="getPriorityClass(ticket)">flag</mat-icon>
                                <mat-icon [ngClass]="getPriorityClass(ticket)">outlined_flag</mat-icon>
                                <mat-icon [ngClass]="getPriorityClass(ticket)">outlined_flag</mat-icon>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ticket-info-card-body">
                    <div class="ticket-data-item">
                        <p class="ticket-data-item-label">Creado</p>
                        <p class="ticket-data-item-value">{{ticket.createdDate | date: 'd MMM yyyy hh:mm a'}}</p>
                    </div>
                    <div class="ticket-data-item">
                        <p class="ticket-data-item-label">Ultima Actualización</p>
                        <p class="ticket-data-item-value">{{ticket.updatedDate | date: 'd MMM yyyy hh:mm a'}}</p>
                    </div>
                    <div class="ticket-data-item">
                        <p class="ticket-data-item-label">Asignado</p>
                        <p class="ticket-data-item-value">{{ticket.assigned.name}}</p>
                    </div>
                    <div class="ticket-data-item">
                        <p class="ticket-data-item-label">Asignador</p>
                        <p class="ticket-data-item-value">{{ticket.assignee.name}}</p>
                    </div>
                </div>
            </div>
            <div class="ticket-card">
                <div class="ticket-card-header">
                    <h4 class="ticket-card-header-title">Cliente</h4>
                    <button class="button button-icon-text button-primary button-raised"><mat-icon>edit</mat-icon><span class="button-label">Editar</span></button>
                </div>
                <div class="ticket-card-body">
                    <div class="ticket-data-item">
                        <p class="ticket-data-item-label">Nombre</p>
                        <p class="ticket-data-item-value">{{ clientName }}</p>
                    </div>
                    <div class="ticket-data-item">
                        <p class="ticket-data-item-label">Email</p>
                        <p class="ticket-data-item-value">{{ clientEmail }}</p>
                    </div>
                    <div class="ticket-data-item">
                        <p class="ticket-data-item-label">Teléfono</p>
                        <p class="ticket-data-item-value">{{ clientPhone }}</p>
                    </div>
                    <div class="ticket-data-item">
                        <p class="ticket-data-item-label">Dirección</p>
                        <p class="ticket-data-item-value">{{ clientAdress }}</p>
                    </div>
                </div>
            </div>
            <div class="ticket-card">
                <div class="ticket-card-header">
                    <h4 class="ticket-card-header-title">Problema</h4>
                    <button class="button button-icon-text button-primary button-raised" (click)="issueReadOnly ? toggleIssueEdit() : submitIssue()"><mat-icon>edit</mat-icon><span class="button-label">{{issueReadOnly ? "Editar" : "Enviar"}}</span></button>
                </div>
                <div class="ticket-card-body">
                    <quill-editor [(ngModel)]="ticketIssue" placeholder="placeholder"></quill-editor>
                    <!-- <shared-rich-text-editor ></shared-rich-text-editor> -->
                    <!-- <div *ngIf="issueReadOnly">
                <quill-editor [(ngModel)] = "ticketIssue"
                              [readOnly]  = "true"
                              class       = "quill-ticket"
                              [style]     = "{ border: '1px solid transparent' }"
                              [modules]   = "{ toolbar: false }">
                </quill-editor>
              </div>
              <div *ngIf="!issueReadOnly">
                <quill-editor [(ngModel)] = "ticketIssue"
                              [style]     = "{ height: '350px', minWidth: '500px' }"
                              [modules]   = "{ toolbar: true }">
                </quill-editor>
              </div> -->
                    <!-- <quill-editor [(ngModel)]="ticketIssue" class="quill-editor">
                <div above-quill-editor-toolbar>
                  above
                </div>
                <div quill-editor-toolbar>
                  <span class="ql-formats">
                    <button class="ql-bold" [title]="'Bold'"></button>
                  </span>
                  <span class="ql-formats">
                    <select class="ql-align" [title]="'Aligment'">
                      <option selected></option>
                      <option value="center"></option>
                      <option value="right"></option>
                      <option value="justify"></option>
                    </select>
                    <select class="ql-align" [title]="'Aligment2'">
                      <option selected></option>
                      <option value="center"></option>
                      <option value="right"></option>
                      <option value="justify"></option>
                    </select>
                  </span>
                </div>
                <div below-quill-editor-toolbar>
                  below
                </div>
              </quill-editor> -->
                    <!-- <p
                *ngIf="issueReadOnly"
                [innerHTML]="ticketIssue"
                class="quill-editor"
              ></p> -->
                </div>
            </div>
        </div>
        <div class="ticket-info">
            <div class="ticket-card">
                <div class="ticket-card-header">
                    <h4 class="ticket-card-header-title">Actualizaciones</h4>
                    <button class="button button-icon-text button-primary button-raised" (click)="addActivity()"><mat-icon>add</mat-icon><span class="button-label">Agregar</span></button>
                </div>
                <div class="ticket-card-body">
                    <div class="default-message" *ngIf="!this.activities">
                        <p>Alguna nueva actividad en el servicio de tu ticket?</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="ticket-info-container">
    <div class="ticket-data-container">
        <div class="ticket-data">
            <div style="display: flex; align-items: baseline">
                <h3 style="margin-right: 10px">Actualizaciones</h3>
                <!-- Add margin-right here -->
                <!-- Button is now next to the title -->
                <button class="button button-primary button-raised button-icon-text" (click)="addActivity()" style="display: flex; align-items: center">
            <mat-icon>add</mat-icon><span class="button-label">Agregar</span>
          </button>
            </div>
            <hr />
            <div class="ticket-data-item" *ngFor="let activity of activities; let i = index" style="
            border: 1px solid #38383854;
            padding: 10px;
            margin-bottom: 10px;
          ">
                <quill-editor [(ngModel)]="activity.activity" *ngIf="!activity.readOnly"></quill-editor>
                <p *ngIf="activity.readOnly" [innerHTML]="activity.activity"></p>

                <hr />
                <div style="
              display: flex;
              align-items: center;
              justify-content: space-between;
            ">
                    <div>
                        <button class="button button-primary button-raised button-icon-text" (click)="
                  activity.readOnly ? toggleActivityEdit(i) : submitActivity(i)
                ">
                <mat-icon>edit</mat-icon
                ><span class="button-label">{{
                  activity.readOnly ? "Editar" : "Enviar"
                }}</span>
              </button>

                        <!-- Delete button -->
                        <button class="button button-danger button-raised button-icon-text" (click)="deleteActivity(i)">
                <mat-icon>delete</mat-icon
                ><span class="button-label">Eliminar</span>
              </button>
                    </div>

                    <p style="text-align: right">{{ i + 1 }}</p>
                </div>
            </div>
        </div>
    </div>
</div>